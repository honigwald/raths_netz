{% extends 'brewery/base.html' %}
{% block content %}

<div class="container-sm">
    <h2>Brauen: {{ charge.amount }} Liter {{ charge.recipe }}</h2>
    {% if charge and charge.preps_finished %}
        <u>Rezept:</u> {{ charge.recipe.name }} <br>
        <u>Menge:</u> {{ charge.amount }} Liter <br>
        <u>Braumeister:</u> {{ charge.brewmaster }}

        <div style="margin-top:10px; padding:5px; border:1px solid black;">
            <h3><u>Aktuell:</u></h3>
            <form action="" method="post">
                {% csrf_token %}
                <table class="table table-sm table-hover" style="vertical-align:top;">
                    <thead class="thead-dark">
                    <tr>
                        <th>Schritt</th> <th>Titel</th> <th>Beschreibung</th> <th>Zutaten</th> <th>Menge</th> <th>Dauer</th> <th>Notizen</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr style="vertical-align: top;">
                        <td>{{ step.step }}</td>
                        <td>{{ step.title }}</td>
                        <td>{{ step.description }}</td>
                        {% if step.ingredient %}
                            <td>{{ step.ingredient }}</td>
                            <td>{{ step.amount }}</td>
                        {% else %}
                            <td></td><td></td>
                        {% endif %}
                        {% if step.duration %}
                            <td>{{ step.duration }}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                        <td>{{ form.comment }}</td>
                    </tr>
                    </tbody>
                </table>
                {% if hint %}
                <h3><u>Hinweis:</u></h3>
                <ul>
                    {% for h in hint %}
                    <li>{{ h }}</li>
                    {% endfor %}
                </ul>
                <br>
                {% endif %}
                <br/>
                {% if step.next %}
                <input type="submit" name="brew_next" value="Weiter">
                {% else %}
                <input type="submit" name="brew_next" value="Speichern">
                {% endif %}
                <input type="hidden" name="charge" value="{{ charge.id }}">
                <input type="hidden" name="t_start" value="{{ t_start|date:'YmdHisu' }} ">
                <input type="hidden" name="step" value="{{ step.id }} ">
            </form>
            <br/>
        </div>

        {% if step.next %}
        <div style="margin-top:10px; padding:5px; border:1px solid black; opacity:0.7">
            <h3><u>Nächster Schritt:</u></h3>
                <table class="table table-sm table-hover" style="vertical-align:top;">
                    <thead class="thead-dark">
                        <tr>
                            <th>Schritt</th> <th>Titel</th> <th>Beschreibung</th> <th>Zutaten</th> <th>Menge</th> <th>Dauer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background-color:white;">
                            <td>{{ step.next.step }}</td>
                            <td>{{ step.next.title }}</td>
                            <td>{{ step.next.description }}</td>
                            <td>{% if step.next.ingredient %}{{ step.next.ingredient }}{% endif %}</td>
                            <td>{% if step.next.amount %}{{ step.next.amount }}{% endif %}</td>
                            <td>{% if step.next.duration %}{{ step.next.duration }}{% endif %}</td>
                        </tr>
                    </tbody>
                </table>
          <a data-toggle="collapse" href="#collapseRecipe" aria-expanded="false" aria-controls="collapseRecipe">
            <u>Aufklappen:</u>
          </a>
          <div class="collapse" id="collapseRecipe" aria-expanded="false" aria-controls="collapseProtocol">
            <table class="table table-sm table-hover" style="vertical-align:top;">
                <thead class="thead-dark">
                </thead>
                <tbody>
                {% for s in recipe %}
                {% if forloop.counter > step.next.step %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ s.title }}</td>
                        <td>{{ s.description }}</td>
                        <td>{% if s.ingredient %}{{ s.ingredient }}{% endif %}</td>
                        <td>{% if s.amount %}{{ s.amount }}{% endif %}</td>
                        <td>{% if s.duration %}{{ s.duration }}{% endif %}</td>
                    </tr>
                {% endif %}
                {% endfor %}
                </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        <div style="margin-top:10px; padding:5px; border:1px solid black;">
          <a data-toggle="collapse" href="#collapseProtocol" aria-expanded="false" aria-controls="collapseProtocol">
            <h3><u>Protokoll:</u></h3>
          </a>
          <div class="collapse" id="collapseProtocol">
                <table class="table table-sm table-hover" style="vertical-align:top;">
                    <thead class="thead-dark">
                        <tr>
                            <th>Schritt</th> <th>Titel</th> <th>Beschreibung</th> <th>Zutaten</th> <th>Menge</th> <th>Dauer</th> <th>Start</th> <th>Ende</th> <th>Notizen</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for p in protocol %}
                    <tr>
                        <td>{{ p.step }}</td>
                        <td>{{ p.title }}</td>
                        <td>{{ p.description }}</td>
                        <td>{{ p.ingredient }}</td>
                        <td>{{ p.amount }}</td>
                        <td>{{ p.duration }}</td>
                        <td>{{ p.tstart }}</td>
                        <td>{{ p.tend }}</td>
                        <td>{{ p.comment }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
          </div>
        </div>

        {% elif charge and not charge.preparations %}
        <div style="margin-top:10px; padding:5px; border:1px solid black;">
            <h3><u>Kalkulierte Zutaten</u></h3>
            <table class="table table-sm table-hover" style="vertical-align:top;">
                <thead class="thead-dark">
                    <tr>
                        <th>Kategorie</th><th>Zutat</th><th>Menge</th>
                    </tr>
                {% for key, value in ingredients.items %}
                </thead>
                <tr>
                    <td>{{ key }} </td>
                    {% for ingr in value %}
                        {% if forloop.counter > 1 %}
                            </tr><tr><td></td>
                        {% endif %}
                        <td>{{ ingr.0 }}</td>
                        <td>{{ ingr.1 }} {{ ingr.2 }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>

        <div style="margin-top:10px; padding:5px; border:1px solid black;">
            <h3><u>Vorarbeiten</u></h3>
            <form action="" method="post">
                {% csrf_token %}
                <table class="table table-hover table-sm">
                    <thead class="thead-dark">
                        <tr>
                            <th>Kategorie</th><th>Beschreibung</th><th>Erledigt</th>
                        </tr>
                    </thead>
                    {% for p, f in list %}
                    <tr style="vertical-align:top;">
                        <td>{{ p.preparation.short }}</td>
                        <td>{{ p.preparation.detail}}</td>
                        <td>{{ f.check }}</td>
                    </tr>
                    {% endfor %}
                </table>
                <br>
                <input type="submit" name="preps_save" value="Speichern">
                <input type="submit" name="preps_next" value="Weiter">
            </form>
        </div>
    {% else %}
        <b><u>Hinweis:</u></b> Wähle Rezept, Menge und Braumeister.<br><br>
        <form action="" method="post">
            {% csrf_token %}
            <table>
            <tr>
                <td>Rezept:</td><td>{{ form.recipe }}</td>
            </tr><tr>
                <td>Menge:</td><td>{{ form.amount }}</td>
            </tr><tr>
                <td>Braumeister:</td><td>{{ form.brewmaster }}</td>
            </tr>
            </table>
            <input type="submit" name="create" value="Erstellen">
        </form>
    {% endif %}
</div>

{% endblock content %}